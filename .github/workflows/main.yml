name: Full deploy (infra → backend → frontend)

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'terraform/**'
  workflow_dispatch:

concurrency:
  group: terraform-deploy
  cancel-in-progress: true

env:
  TF_DIR: terraform/infra
  SERVICES_DIR: terraform/services
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend

jobs:
  infra:
    name: Infra (terraform infra)
    runs-on: ubuntu-latest
    outputs:
      db_host: ${{ steps.tf_outputs.outputs.db_host }}
      db_user: ${{ steps.tf_outputs.outputs.db_user }}
      db_name: ${{ steps.tf_outputs.outputs.db_name }}
      vpc_connector_id: ${{ steps.tf_outputs.outputs.vpc_connector_id }}
      backend_repo: ${{ steps.tf_outputs.outputs.backend_repo }}
      frontend_repo: ${{ steps.tf_outputs.outputs.frontend_repo }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN2 }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud config set run/region ${{ secrets.GCP_REGION }}
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Enable required GCP APIs
        run: |
          gcloud services enable servicenetworking.googleapis.com \
                                 vpcaccess.googleapis.com \
                                 run.googleapis.com \
                                 compute.googleapis.com \
                                 artifactregistry.googleapis.com \
                                 sqladmin.googleapis.com

      - name: Terraform init
        run: |
          cd $TF_DIR
          rm -rf .terraform || true
          rm -f .terraform.lock.hcl || true
          terraform init -input=false -upgrade

      - name: Terraform apply
        run: |
          cd $TF_DIR
          terraform apply -auto-approve

      - name: Read terraform outputs
        id: tf_outputs
        run: |
          cd $TF_DIR
          echo "db_host=$(terraform output -raw db_private_ip)" >> $GITHUB_OUTPUT
          echo "db_user=$(terraform output -raw db_user)" >> $GITHUB_OUTPUT
          echo "db_name=$(terraform output -raw db_name)" >> $GITHUB_OUTPUT
          echo "vpc_connector_id=$(terraform output -raw vpc_connector_id)" >> $GITHUB_OUTPUT
          echo "backend_repo=$(terraform output -raw backend_repo)" >> $GITHUB_OUTPUT
          echo "frontend_repo=$(terraform output -raw frontend_repo)" >> $GITHUB_OUTPUT

  common:
    name: Services - common (service account)
    runs-on: ubuntu-latest
    needs: infra
    outputs:
      service_account_email: ${{ steps.outputs.outputs.service_account_email }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN2 }}

      - name: Terraform init (common)
        run: |
          cd terraform/services/common
          rm -rf .terraform || true
          rm -f .terraform.lock.hcl || true
          terraform init -input=false -upgrade

      - name: Terraform apply (common)
        id: outputs
        run: |
          cd terraform/services/common
          terraform apply -auto-approve -var="project_id=${{ secrets.GCP_PROJECT }}"
          echo "service_account_email=$(terraform output -raw service_account_email)" >> $GITHUB_OUTPUT


  build-backend:
    name: Build & push backend image
    runs-on: ubuntu-latest
    needs: [infra, common]
    outputs:
      backend_image: ${{ steps.build.outputs.backend_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure gcloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure docker auth
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push backend
        id: build
        env:
          REGION: ${{ secrets.GCP_REGION }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
          BACKEND_REPO: ${{ needs.infra.outputs.backend_repo }}
          DB_HOST: ${{ needs.infra.outputs.db_host }}
          DB_USER: ${{ needs.infra.outputs.db_user }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ needs.infra.outputs.db_name }}
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${BACKEND_REPO}/store-backend:${GITHUB_SHA::8}"
          docker build --build-arg DB_SERVER_IP=${DB_HOST} -t "$IMAGE" "$GITHUB_WORKSPACE/${{ env.BACKEND_DIR }}"
          docker push "$IMAGE"
          echo "backend_image=$IMAGE" >> $GITHUB_OUTPUT

  deploy-backend:
    name: Deploy backend (terraform module.backend)
    runs-on: ubuntu-latest
    needs: [build-backend, infra, common]
    outputs:
      backend_url: ${{ steps.deploy.outputs.backend_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN2 }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform init (backend)
        run: |
          cd terraform/services/backend
          rm -rf .terraform || true
          rm -f .terraform.lock.hcl || true
          terraform init -input=false -upgrade

      - name: Apply backend module only
        id: deploy
        env:
          DB_HOST: ${{ needs.infra.outputs.db_host }}
          DB_USER: ${{ needs.infra.outputs.db_user }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ needs.infra.outputs.db_name }}
          BACKEND_IMAGE: ${{ needs.build-backend.outputs.backend_image }}
          VPC_CONNECTOR_ID: ${{ needs.infra.outputs.vpc_connector_id }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          SERVICE_ACCOUNT_EMAIL: ${{ needs.common.outputs.service_account_email }}
        run: |
          cd terraform/services/backend
          terraform apply -auto-approve \
            -var="project_id=$GCP_PROJECT" \
            -var="region=$GCP_REGION" \
            -var="service_name=store-backend" \
            -var="db_private_ip=${DB_HOST}" \
            -var="db_user=${DB_USER}" \
            -var="db_password=${DB_PASS}" \
            -var="db_name=${DB_NAME}" \
            -var="backend_image=${BACKEND_IMAGE}" \
            -var="vpc_connector_id=${VPC_CONNECTOR_ID}" \
            -var="service_account_email=${SERVICE_ACCOUNT_EMAIL}"
          echo "backend_url=$(terraform output -raw backend_url)" >> $GITHUB_OUTPUT

  build-frontend:
    name: Build & push frontend image
    runs-on: ubuntu-latest
    needs: [deploy-backend, infra]
    outputs:
      frontend_image: ${{ steps.build_frontend.outputs.frontend_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure gcloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure docker auth
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push frontend
        id: build_frontend
        env:
          REGION: ${{ secrets.GCP_REGION }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
          FRONTEND_REPO: ${{ needs.infra.outputs.frontend_repo }}
          BACKEND_URL: ${{ needs.deploy-backend.outputs.backend_url }}
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${FRONTEND_REPO}/store-frontend:${GITHUB_SHA::8}"
          docker build --build-arg REACT_APP_API_URL=$BACKEND_URL -t "$IMAGE" "$GITHUB_WORKSPACE/${{ env.FRONTEND_DIR }}"
          docker push "$IMAGE"
          echo "frontend_image=$IMAGE" >> $GITHUB_OUTPUT

  deploy-services:
    name: Deploy all services (final apply)
    runs-on: ubuntu-latest
    needs: [build-frontend, deploy-backend]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN2 }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform init (frontend)
        run: |
          cd terraform/services/frontend
          rm -rf .terraform || true
          rm -f .terraform.lock.hcl || true
          terraform init -input=false -upgrade

      - name: Apply frontend module
        env:
          FRONTEND_IMAGE: ${{ needs.build-frontend.outputs.frontend_image }}
          BACKEND_URL: ${{ needs.deploy-backend.outputs.backend_url }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
        run: |
          cd terraform/services/frontend
          terraform apply -auto-approve \
            -var="project_id=${GCP_PROJECT}" \
            -var="region=${GCP_REGION}" \
            -var="service_name=frontend-service" \
            -var="frontend_image=${FRONTEND_IMAGE}" \
            -var="backend_url=${BACKEND_URL}"