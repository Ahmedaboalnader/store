name: Full deploy (infra -> backend -> frontend)

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'terraform/**'
  workflow_dispatch:

concurrency:
  group: terraform-deploy
  cancel-in-progress: true   

env:
  TF_DIR: terraform/infra
  SERVICES_DIR: terraform/services
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend

jobs: 
  deploy-all:
    runs-on: ubuntu-latest
    env:
      TERRAFORM_TOKEN: ${{ secrets.TFC_TOKEN }}
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ">= 1.0.0, < 2.0.0"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'terraform/services/**/backend/**'
            frontend:
              - 'frontend/**'
              - 'terraform/services/**/frontend/**'
            infra:
              - 'terraform/infra/**'
              - 'terraform/modules/**'

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud project & region
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud config set run/region ${{ secrets.GCP_REGION }}
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      # ---------------------------
      # 1) Enable required GCP APIs
      # ---------------------------
      - name: Enable required GCP APIs
        if: steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          gcloud services enable servicenetworking.googleapis.com \
                                 vpcaccess.googleapis.com \
                                 run.googleapis.com \
                                 compute.googleapis.com \
                                 artifactregistry.googleapis.com \
                                 sqladmin.googleapis.com
          echo "✅ GCP APIs enabled."

      # ---------------------------
      # 2) Infra: init / plan / apply
      # ---------------------------
      - name: Terraform init (infra)
        if: steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd $TF_DIR
          terraform init -input=false -upgrade

      - name: Terraform plan (infra)
        if: steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd $TF_DIR
          terraform plan -out=tfplan

      - name: Terraform apply (infra)
        if: steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd $TF_DIR
          terraform apply -auto-approve
          terraform output -json > tf-outputs.json

      # ---------------------------
      # 3) Load infra outputs safely
      # ---------------------------
      - name: Load infra outputs
        run: |
          cd $TF_DIR
          if [ -n "$(terraform output -raw db_private_ip 2>/dev/null)" ]; then
            echo "DATABASE_IP=$(terraform output -raw db_private_ip)" >> $GITHUB_ENV
          fi
          if [ -n "$(terraform output -raw vpc_connector_id 2>/dev/null)" ]; then
            echo "VPC_CONNECTOR_ID=$(terraform output -raw vpc_connector_id)" >> $GITHUB_ENV
          fi
          if [ -n "$(terraform output -raw backend_repo 2>/dev/null)" ]; then
            echo "BACKEND_REPO=$(terraform output -raw backend_repo)" >> $GITHUB_ENV
          fi
          if [ -n "$(terraform output -raw frontend_repo 2>/dev/null)" ]; then
            echo "FRONTEND_REPO=$(terraform output -raw frontend_repo)" >> $GITHUB_ENV
          fi

      # ---------------------------
      # 4) Build & push backend image
      # ---------------------------
      - name: Build & push backend image
        if: steps.changes.outputs.backend == 'true' || steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        env:
          REGION: ${{ secrets.GCP_REGION }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${BACKEND_REPO}/store-backend:${GITHUB_SHA::8}"
          docker build -t "$IMAGE" ./backend
          docker push "$IMAGE"
          echo "BACKEND_IMAGE=$IMAGE" >> $GITHUB_ENV

      # ---------------------------
      # 5) Build & push frontend image
      # ---------------------------
      - name: Build & push frontend image
        if: steps.changes.outputs.frontend == 'true' || steps.changes.outputs.backend == 'true' || steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        env:
          REGION: ${{ secrets.GCP_REGION }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${FRONTEND_REPO}/store-frontend:${GITHUB_SHA::8}"
          docker build -t "$IMAGE" ./frontend
          docker push "$IMAGE"
          echo "FRONTEND_IMAGE=$IMAGE" >> $GITHUB_ENV

      # ---------------------------
      # 6) Deploy Cloud Run services (via Terraform)
      # ---------------------------
      - name: Configure Terraform Cloud credentials
        run: |
          mkdir -p ~/.terraform.d
          echo "{\"credentials\": {\"app.terraform.io\": {\"token\": \"${{ secrets.TF_API_TOKEN }}\"}}}" > ~/.terraform.d/credentials.tfrc.json

      - name: Clean old Terraform state & lock
        run: |
         cd $SERVICES_DIR
         rm -rf .terraform
         rm -f .terraform.lock.hcl
         echo "✅ Old Terraform state and lock removed"

      - name: Terraform Init (Services)
        run: |
          cd $SERVICES_DIR
          terraform init -input=false -upgrade
      
      - name: Test Terraform Cloud remote state access
        run: |
         cd $SERVICES_DIR
         terraform console -state=<(terraform state pull) <<< 'data.terraform_remote_state.infra.outputs'
    

      - name: Debug environment before apply
        run: |
          echo "DATABASE_IP=$DATABASE_IP"
          echo "VPC_CONNECTOR_ID=$VPC_CONNECTOR_ID"
          echo "BACKEND_IMAGE=$BACKEND_IMAGE"
          echo "FRONTEND_IMAGE=$FRONTEND_IMAGE"
          echo "GCP_PROJECT=${{ secrets.GCP_PROJECT }}"
          echo "GCP_REGION=${{ secrets.GCP_REGION }}"

      - name: Terraform deploy services
        if: steps.changes.outputs.backend == 'true' || steps.changes.outputs.frontend == 'true' || steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        env:
          DATABASE_IP: ${{ env.DATABASE_IP }}
          VPC_CONNECTOR_ID: ${{ env.VPC_CONNECTOR_ID }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
        run: |
          cd $SERVICES_DIR
          terraform apply -auto-approve \
            -var="db_private_ip=$DATABASE_IP" \
            -var="vpc_connector_id=$VPC_CONNECTOR_ID" \
            -var="backend_image=$BACKEND_IMAGE" \
            -var="frontend_image=$FRONTEND_IMAGE" \
            -var="project_id=$GCP_PROJECT" \
            -var="region=$GCP_REGION"

      # ---------------------------
      # 7) Get backend URL after deploy
      # ---------------------------
      - name: Get backend URL
        run: |
          cd $SERVICES_DIR
          if [ -n "$(terraform output -raw backend_url 2>/dev/null)" ]; then
            BACKEND_URL=$(terraform output -raw backend_url)
            echo "BACKEND_URL=${BACKEND_URL}" >> $GITHUB_ENV
            echo "Backend URL: ${BACKEND_URL}"
          fi

      # ---------------------------
      # 8) Final summary
      # ---------------------------
      - name: Final output
        run: |
          echo "============================"
          echo "✅ Deployment summary"
          echo "Backend image: $BACKEND_IMAGE"
          echo "Frontend image: $FRONTEND_IMAGE"
          echo "Backend URL: $BACKEND_URL"
          echo "Database IP: $DATABASE_IP"
          echo "VPC Connector ID: $VPC_CONNECTOR_ID"
          echo "============================"
