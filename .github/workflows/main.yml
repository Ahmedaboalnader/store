name: Full deploy (infra -> backend -> frontend)

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'terraform/**'
  workflow_dispatch:

concurrency:
  group: terraform-deploy
  cancel-in-progress: true   

env:
  TF_DIR: terraform/infra
  SERVICES_DIR: terraform/services
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend

jobs: 
  deploy-all:
    runs-on: ubuntu-latest
    env:
      TF_CLOUD_ORGANIZATION: ahmedaboalnder
      TF_CLOUD_WORKSPACE: my-infra
      TF_API_TOKEN: ${{ secrets.TF_API_TOKEN2 }}
      TERRAFORM_TOKEN: ${{ secrets.TFC_TOKEN }}
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.7"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN2 }}

      - name: Detect changed paths
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'terraform/services/**/backend/**'
            frontend:
              - 'frontend/**'
              - 'terraform/services/**/frontend/**'
            infra:
              - 'terraform/infra/**'
              - 'terraform/modules/**'

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud project & region
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud config set run/region ${{ secrets.GCP_REGION }}
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Enable required GCP APIs
        if: steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          gcloud services enable servicenetworking.googleapis.com \
                                 vpcaccess.googleapis.com \
                                 run.googleapis.com \
                                 compute.googleapis.com \
                                 artifactregistry.googleapis.com \
                                 sqladmin.googleapis.com
          echo "✅ GCP APIs enabled."

      - name: Terraform init (infra)
        if: steps.changes.outputs.infra == 'true' || steps.changes.outputs.backend == 'true' || steps.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd $TF_DIR
          terraform init -input=false -upgrade

      - name: Terraform apply (infra)
        if: steps.changes.outputs.infra == 'true' || steps.changes.outputs.backend == 'true' || steps.changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          cd $TF_DIR
          terraform apply -auto-approve
          terraform output -json > tf-outputs.json

      - name: Load infra outputs
        run: |
          cd $TF_DIR
          echo "DB_HOST=$(terraform output -raw db_private_ip)" >> $GITHUB_ENV
          echo "DB_USER=$(terraform output -raw db_user)" >> $GITHUB_ENV
          echo "DB_NAME=$(terraform output -raw db_name)" >> $GITHUB_ENV
          echo "VPC_CONNECTOR_ID=$(terraform output -raw vpc_connector_id)" >> $GITHUB_ENV
          echo "DATABASE_IP=$(terraform output -raw db_private_ip)" >> $GITHUB_ENV
          echo "BACKEND_REPO=$(terraform output -raw backend_repo)" >> $GITHUB_ENV
          echo "FRONTEND_REPO=$(terraform output -raw frontend_repo)" >> $GITHUB_ENV

      - name: Build & push backend image
        if: steps.changes.outputs.backend == 'true' || steps.changes.outputs.infra == 'true' || github.event_name == 'workflow_dispatch'
        id: build_backend
        env:
          REGION: ${{ secrets.GCP_REGION }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${BACKEND_REPO}/store-backend:${GITHUB_SHA::8}"
          docker build -t "$IMAGE" ./backend
          docker push "$IMAGE"
          echo "BACKEND_IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Terraform Init (Services)
        run: |
          cd $SERVICES_DIR
          terraform init -input=false -upgrade

      - name: Get Backend URL
        id: get_backend_url
        if: steps.build_backend.conclusion == 'success'
        env:
          DB_HOST: ${{ env.DB_HOST }}
          DB_USER: ${{ env.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ env.DB_NAME }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
          VPC_CONNECTOR_ID: ${{ env.VPC_CONNECTOR_ID }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
        run: |
          cd $SERVICES_DIR
          # Temporarily apply only the backend to get its URL
          terraform apply -auto-approve -target=module.backend \
            -var="db_private_ip=$DB_HOST" \
            -var="db_user=$DB_USER" \
            -var="db_password=$DB_PASS" \
            -var="db_name=$DB_NAME" \
            -var="backend_image=$BACKEND_IMAGE" \
            -var="vpc_connector_id=$VPC_CONNECTOR_ID" \
            -var="project_id=$GCP_PROJECT" \
            -var="region=$GCP_REGION"
          echo "BACKEND_URL=$(terraform output -raw backend_url)" >> $GITHUB_ENV

      - name: Build & push frontend image (with backend URL)
        id: build_frontend
        if: steps.get_backend_url.conclusion == 'success' || steps.changes.outputs.frontend == 'true'
        env:
          REGION: ${{ secrets.GCP_REGION }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
          BACKEND_URL: ${{ env.BACKEND_URL }}
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${FRONTEND_REPO}/store-frontend:${GITHUB_SHA::8}"
          docker build --build-arg REACT_APP_API_URL=$BACKEND_URL -t "$IMAGE" ./frontend
          docker push "$IMAGE"
          echo "FRONTEND_IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy All Services
        if: steps.build_frontend.conclusion == 'success' || steps.build_backend.conclusion == 'success'
        env:
          DB_HOST: ${{ env.DB_HOST }}
          DB_USER: ${{ env.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ env.DB_NAME }}
          BACKEND_IMAGE: ${{ env.BACKEND_IMAGE }}
          FRONTEND_IMAGE: ${{ env.FRONTEND_IMAGE }}
          VPC_CONNECTOR_ID: ${{ env.VPC_CONNECTOR_ID }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
        run: |
          cd $SERVICES_DIR
          terraform apply -auto-approve \
            -var="db_private_ip=$DB_HOST" \
            -var="db_user=$DB_USER" \
            -var="db_password=$DB_PASS" \
            -var="db_name=$DB_NAME" \
            -var="backend_image=$BACKEND_IMAGE" \
            -var="frontend_image=$FRONTEND_IMAGE" \
            -var="vpc_connector_id=$VPC_CONNECTOR_ID" \
            -var="project_id=$GCP_PROJECT" \
            -var="region=$GCP_REGION"

      - name: Final output
        run: |
          echo "============================"
          echo "✅ Deployment summary"
          echo "Backend image: $BACKEND_IMAGE"
          echo "Frontend image: $FRONTEND_IMAGE"
          echo "Backend URL: $BACKEND_URL"
          echo "Database IP: $DATABASE_IP"
          echo "VPC Connector ID: $VPC_CONNECTOR_ID"
          echo "============================