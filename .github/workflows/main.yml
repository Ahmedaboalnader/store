name: Full deploy (infra → backend → frontend)

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'terraform/**'
  workflow_dispatch:

concurrency:
  group: terraform-deploy
  cancel-in-progress: true

env:
  TF_DIR: terraform/infra
  SERVICES_DIR: terraform/services
  BACKEND_DIR: backend
  FRONTEND_DIR: frontend

jobs:
  infra:
    name: Infra (terraform infra)
    runs-on: ubuntu-latest
    outputs:
      db_host: ${{ steps.tf_outputs.outputs.db_host }}
      db_user: ${{ steps.tf_outputs.outputs.db_user }}
      db_name: ${{ steps.tf_outputs.outputs.db_name }}
      vpc_connector_id: ${{ steps.tf_outputs.outputs.vpc_connector_id }}
      backend_repo: ${{ steps.tf_outputs.outputs.backend_repo }}
      frontend_repo: ${{ steps.tf_outputs.outputs.frontend_repo }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN2 }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure gcloud
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud config set run/region ${{ secrets.GCP_REGION }}
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Enable required GCP APIs
        run: |
          gcloud services enable servicenetworking.googleapis.com \
                                 vpcaccess.googleapis.com \
                                 run.googleapis.com \
                                 compute.googleapis.com \
                                 artifactregistry.googleapis.com \
                                 sqladmin.googleapis.com

      - name: Terraform init
        run: |
          cd $TF_DIR
          rm -rf .terraform || true
          rm -f .terraform.lock.hcl || true
          terraform init -input=false -upgrade

      - name: Terraform apply
        run: |
          cd $TF_DIR
          terraform apply -auto-approve

      - name: Read terraform outputs
        id: tf_outputs
        run: |
          cd $TF_DIR
          echo "db_host=$(terraform output -raw db_private_ip)" >> $GITHUB_OUTPUT
          echo "db_user=$(terraform output -raw db_user)" >> $GITHUB_OUTPUT
          echo "db_name=$(terraform output -raw db_name)" >> $GITHUB_OUTPUT
          echo "vpc_connector_id=$(terraform output -raw vpc_connector_id)" >> $GITHUB_OUTPUT
          echo "backend_repo=$(terraform output -raw backend_repo)" >> $GITHUB_OUTPUT
          echo "frontend_repo=$(terraform output -raw frontend_repo)" >> $GITHUB_OUTPUT

  build-backend:
    name: Build & push backend image
    runs-on: ubuntu-latest
    needs: [infra]
    outputs:
      backend_image: ${{ steps.build.outputs.backend_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure gcloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure docker auth
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push backend
        id: build
        env:
          REGION: ${{ secrets.GCP_REGION }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
          BACKEND_REPO: ${{ needs.infra.outputs.backend_repo }}
          DB_HOST: ${{ needs.infra.outputs.db_host }}
          DB_USER: ${{ needs.infra.outputs.db_user }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ needs.infra.outputs.db_name }}
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${BACKEND_REPO}/store-backend:${GITHUB_SHA::8}"
          docker build --build-arg DB_SERVER_IP=${DB_HOST} -t "$IMAGE" "$GITHUB_WORKSPACE/${{ env.BACKEND_DIR }}"
          docker push "$IMAGE"
          echo "backend_image=$IMAGE" >> $GITHUB_OUTPUT

  build-frontend:
    name: Build & push frontend image
    runs-on: ubuntu-latest
    needs: [infra]
    outputs:
      frontend_image: ${{ steps.build_frontend.outputs.frontend_image }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure gcloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure docker auth
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push frontend
        id: build_frontend
        env:
          REGION: ${{ secrets.GCP_REGION }}
          PROJECT: ${{ secrets.GCP_PROJECT }}
          FRONTEND_REPO: ${{ needs.infra.outputs.frontend_repo }}
          BACKEND_URL: "https://store-backend-service-gcr-4f5v2x3a-uc.a.run.app" # Placeholder, will be replaced by terraform output
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${FRONTEND_REPO}/store-frontend:${GITHUB_SHA::8}"
          docker build --build-arg REACT_APP_API_URL=$BACKEND_URL -t "$IMAGE" "$GITHUB_WORKSPACE/${{ env.FRONTEND_DIR }}"
          docker push "$IMAGE"
          echo "frontend_image=$IMAGE" >> $GITHUB_OUTPUT

  import-common:
    name: Import common resources
    runs-on: ubuntu-latest
    needs: [infra]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN2 }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Import existing common resources (if any)
        run: |
          bash scripts/import-common.sh ${{ secrets.GCP_PROJECT }} ${{ secrets.GCP_REGION }} || true

  deploy-services:
    name: Deploy all services (final apply)
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend, import-common]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.5.7'
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN2 }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform init
        run: |
          cd $SERVICES_DIR
          terraform init -input=false -upgrade

      - name: Terraform apply
        env:
          FRONTEND_IMAGE: ${{ needs.build-frontend.outputs.frontend_image }}
          BACKEND_IMAGE: ${{ needs.build-backend.outputs.backend_image }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          DB_PASS: ${{ secrets.DB_PASS }}
        run: |
          cd $SERVICES_DIR
          terraform apply -auto-approve \
            -var="project_id=${GCP_PROJECT}" \
            -var="region=${GCP_REGION}" \
            -var="backend_image=${BACKEND_IMAGE}" \
            -var="frontend_image=${FRONTEND_IMAGE}" \
            -var="db_password=${DB_PASS}"